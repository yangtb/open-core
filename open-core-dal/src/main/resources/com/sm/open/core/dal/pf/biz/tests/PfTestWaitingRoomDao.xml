<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sm.open.core.dal.pf.biz.tests.PfTestWaitingRoomDao">
    <insert id="startExam" useGeneratedKeys="true" keyProperty="idTestexec">
        INSERT INTO exm_testexec
        (
        <trim suffixOverrides=",">
            <if test="idTestexec!=null">
                id_testexec,
            </if>
            <if test="idTestplanDetail!=null">
                id_testplan_detail,
            </if>
            <if test="idStudent!=null">
                id_student,
            </if>
            <if test="idMedicalrec!=null">
                id_medicalrec,
            </if>
            <if test="sort!=null">
                sort,
            </if>
            <if test="idOrg!=null">
                id_org,
            </if>
            <if test="sdTestexec!=null">
                sd_testexec,
            </if>
                dt_exec_begin,
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexec!=null">
                #{idTestexec},
            </if>
            <if test="idTestplanDetail!=null">
                #{idTestplanDetail},
            </if>
            <if test="idStudent!=null">
                #{idStudent},
            </if>
            <if test="idMedicalrec!=null">
                #{idMedicalrec},
            </if>
            <if test="sort!=null">
                #{sort},
            </if>
            <if test="idOrg!=null">
                #{idOrg},
            </if>
            <if test="sdTestexec!=null">
                #{sdTestexec},
            </if>
                now(),
        </trim>
        )
    </insert>
    <insert id="insertExmMedResult" useGeneratedKeys="true" keyProperty="idTestexecResult">
        INSERT INTO exm_med_result
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="idTestexec!=null">
                id_testexec,
            </if>
            <if test="serial!=null">
                serial,
            </if>
            <if test="fgFinalResult!=null">
                fg_final_result,
            </if>
            <if test="fgAsses!=null">
                fg_asses,
            </if>
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="idTestexec!=null">
                #{idTestexec},
            </if>
            <if test="serial!=null">
                #{serial},
            </if>
            <if test="fgFinalResult!=null">
                #{fgFinalResult},
            </if>
            <if test="fgAsses!=null">
                #{fgAsses},
            </if>
        </trim>
        )
    </insert>
    <insert id="saveConsQa"  useGeneratedKeys="true" keyProperty="idTestexecResultInques">
        INSERT INTO exm_med_result_inques
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultInques!=null">
                id_testexec_result_inques,
            </if>
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="idInques!=null">
                id_inques,
            </if>
            <if test="idMedCaseList!=null">
                id_med_case_list,
            </if>
                fg_clue,
                gmt_create,
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultInques!=null">
                #{idTestexecResultInques},
            </if>
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="idInques!=null">
                #{idInques},
            </if>
            <if test="idMedCaseList!=null">
                #{idMedCaseList},
            </if>
                '0',
                now(),
        </trim>
        )
    </insert>
    <insert id="saveCheckQa"  useGeneratedKeys="true" keyProperty="idTestexecResultBody">
        INSERT INTO exm_med_result_body
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultBody!=null">
                id_testexec_result_body,
            </if>
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="idBody!=null">
                id_body,
            </if>
            <if test="idMedCaseList!=null">
                id_med_case_list,
            </if>
                fg_clue,
                gmt_create,
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultBody!=null">
                #{idTestexecResultBody},
            </if>
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="idBody!=null">
                #{idBody},
            </if>
            <if test="idMedCaseList!=null">
                #{idMedCaseList},
            </if>
                '0',
                now(),
        </trim>
        )
    </insert>
    <insert id="saveExamQa" useGeneratedKeys="true" keyProperty="idTestexecResultInspect">
        INSERT INTO exm_med_result_inspect
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultInspect!=null">
                id_testexec_result_inspect,
            </if>
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="idMedCaseList!=null">
                id_med_case_list,
            </if>
            <if test="idInspectItem!=null">
                id_inspect_item,
            </if>
            <if test="idDie!=null">
                id_die,
            </if>
                fg_clue,
                gmt_create,
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultInspect!=null">
                #{idTestexecResultInspect},
            </if>
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="idMedCaseList!=null">
                #{idMedCaseList},
            </if>
            <if test="idInspectItem!=null">
                #{idInspectItem},
            </if>
            <if test="idDie!=null">
                #{idDie},
            </if>
                '0',
                now(),
        </trim>
        )
    </insert>
    <insert id="saveReferral" useGeneratedKeys="true" keyProperty="idTestexecResultReferral">
        INSERT INTO exm_med_result_referral
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultReferral!=null">
                id_testexec_result_referral,
            </if>
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="idDie!=null">
                id_die,
            </if>
                fg_exclude,
                gmt_create,
                gmt_modify
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultReferral!=null">
                #{idTestexecResultReferral},
            </if>
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="idDie!=null">
                #{idDie},
            </if>
                '0', now(), now()
        </trim>
        )
    </insert>
    <insert id="saveOrder" useGeneratedKeys="true" keyProperty="idTestexecResultOrder">
        INSERT INTO exm_med_result_order
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultOrder!=null">
                id_testexec_result_order,
            </if>
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="desCheck!=null and desCheck != ''">
                des_check,
            </if>
            <if test="sdNursRout!=null and sdNursRout != ''">
                sd_nurs_rout,
            </if>
            <if test="cdNursLevel!=null and cdNursLevel != ''">
                cd_nurs_level,
            </if>
            <if test="sdDiet!=null and sdDiet != ''">
                sd_diet,
            </if>
            <if test="sdPosition!=null and sdPosition != ''">
                sd_position,
            </if>
            <if test="desSpecial!=null and desSpecial != ''">
                des_special,
            </if>
            <if test="fgValid!=null and fgValid!= ''">
                fg_valid,
            </if>
                gmt_create,
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultOrder!=null">
                #{idTestexecResultOrder},
            </if>
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="desCheck!=null and desCheck != ''">
                #{desCheck},
            </if>
            <if test="sdNursRout!=null and sdNursRout != ''">
                #{sdNursRout},
            </if>
            <if test="cdNursLevel!=null and cdNursLevel != ''">
                #{cdNursLevel},
            </if>
            <if test="sdDiet!=null and sdDiet != ''">
                #{sdDiet},
            </if>
            <if test="sdPosition!=null and sdPosition != ''">
                #{sdPosition},
            </if>
            <if test="desSpecial!=null and desSpecial != ''">
                #{desSpecial},
            </if>
            <if test="fgValid!=null and fgValid != ''">
                #{fgValid},
            </if>
                now(),
        </trim>
        )
    </insert>
    <insert id="saveLongDrugs" useGeneratedKeys="true" keyProperty="idOrderLongDrugs">
        INSERT INTO exm_med_result_order_log_drugs
        (
            id_testexec_result_order,
            id_long_drugs
        )
        VALUES
        <foreach collection="list" item="item" separator="," >
                (#{extId}, #{item})
        </foreach>
    </insert>
    <insert id="saveShortDrugs">
        INSERT INTO exm_med_result_order_short_drugs
        (
            id_testexec_result_order,
            id_short_drugs
        )
        VALUES
        <foreach collection="list" item="item" separator="," >
            (#{extId}, #{item})
        </foreach>
    </insert>
    <insert id="addDiagnosis"  useGeneratedKeys="true" keyProperty="idTestexecResultDiagnosis">
        INSERT INTO exm_med_result_diagnosis
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultDiagnosis!=null">
                id_testexec_result_diagnosis,
            </if>
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="idDie!=null">
                id_die,
            </if>
            <if test="idTestexecResultReferral!=null">
                id_testexec_result_referral,
            </if>
                gmt_create,
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultDiagnosis!=null">
                #{idTestexecResultDiagnosis},
            </if>
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="idDie!=null">
                #{idDie},
            </if>
            <if test="idTestexecResultReferral!=null">
                #{idTestexecResultReferral},
            </if>
                now(),
        </trim>
        )
    </insert>
    <insert id="addSummary" useGeneratedKeys="true" keyProperty="idTestexecResultSumary">
        INSERT INTO exm_med_result_summary
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultSumary!=null">
                id_testexec_result_sumary,
            </if>
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="dieSumary!=null">
                die_sumary,
            </if>
                gmt_create,
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultSumary!=null">
                #{idTestexecResultSumary},
            </if>
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="dieSumary!=null">
                #{dieSumary},
            </if>
                now(),
        </trim>
        )
    </insert>
    <insert id="saveDieReason">
        INSERT INTO exm_med_result_die_reason
        (
            id_testexec_result_diagnosis,
            sd_eva_effciency,
            id_med_case_list,
            id_inques,
            id_body,
            id_inspect_item,
            gmt_create
        )
        VALUES
        <foreach collection="list" item="item" separator="," >
            (
                #{item.idTestexecResultDiagnosis},
                #{item.sdEvaEffciency},
                #{item.idMedCaseList},
                <choose>
                    <when test="item.idInques!=null">
                        #{item.idInques},
                    </when>
                    <otherwise>
                        null,
                    </otherwise>
                </choose>
                <choose>
                    <when test="item.idBody!=null">
                        #{item.idBody},
                    </when>
                    <otherwise>
                        null,
                    </otherwise>
                </choose>
                <choose>
                    <when test="item.idInspectItem!=null">
                        #{item.idInspectItem},
                    </when>
                    <otherwise>
                        null,
                    </otherwise>
                </choose>
                now()
            )
        </foreach>
    </insert>
    <insert id="saveQzDieReason">
        INSERT INTO exm_med_result_die_reason
        (
            id_testexec_result_diagnosis,
            sd_eva_effciency,
            id_med_case_list,
            id_inques,
            id_body,
            id_inspect_item,
            gmt_create
        )
        SELECT
            #{idTestexecResultDiagnosis} ,
            b.sd_eva_effciency ,
            b.id_med_case_list ,
            b.id_inques ,
            b.id_body ,
            b.id_inspect_item ,
            now()
        FROM
            exm_med_result_referral_reason b
        WHERE
            b.id_testexec_result_referral = #{idTestexecResultReferral}
    </insert>
    <insert id="saveReferralReason">
        INSERT INTO exm_med_result_referral_reason(
            id_testexec_result_referral ,
            fg_exclude ,
            sd_eva_effciency ,
            id_inques ,
            id_body ,
            id_inspect_item ,
            id_med_case_list ,
            fg_valid ,
            gmt_create
        )
        VALUES
        <foreach collection="list" item="item" separator="," >
            (
            #{item.idTestexecResultReferral},
            #{item.fgExclude},
            #{item.sdEvaEffciency},
            <choose>
                <when test="item.idInques!=null">
                    #{item.idInques},
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.idBody!=null">
                    #{item.idBody},
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            <choose>
                <when test="item.idInspectItem!=null">
                    #{item.idInspectItem},
                </when>
                <otherwise>
                    null,
                </otherwise>
            </choose>
            #{item.idMedCaseList},
            '0',
            now()
            )
        </foreach>
    </insert>
    <update id="endExam">
        update
            exm_testexec
        set
            dt_exec_end=now(),
            duration=TIMESTAMPDIFF(SECOND, dt_exec_begin, now()),
            sd_testexec='2'
        where
            id_testexec = #{idTestexec}
    </update>
    <update id="updateConsStatus">
        update
            exm_med_result_inques
        set
            fg_clue=#{status}
        where
            id_testexec_result_inques  in (
        <foreach collection="list" item="item" separator="," >
            #{item}
        </foreach>
        )
    </update>
    <update id="updateCheckStatus">
        update
            exm_med_result_body
        set
            fg_clue=#{status}
        where
            id_testexec_result_body  in (
        <foreach collection="list" item="item" separator="," >
            #{item}
        </foreach>
        )
    </update>
    <update id="updateExamStatus">
        update
            exm_med_result_inspect
        set
            fg_clue=#{status}
        where
            id_testexec_result_inspect  in (
        <foreach collection="list" item="item" separator="," >
            #{item}
        </foreach>
        )
    </update>
    <update id="delConsQa">
        update exm_med_result_inques
        set fg_valid=#{fgValid},
            gmt_create=now()
        where id_testexec_result_inques = #{idTestexecResultInques}
    </update>
    <update id="outReferral">
        update
            exm_med_result_referral
        set
            fg_exclude = '1',  gmt_modify = now()
        where
            id_testexec_result_referral = #{idTestexecResultReferral}
    </update>
    <update id="editOrder">
        UPDATE exm_med_result_order
        SET
            des_check = #{desCheck},
            sd_nurs_rout = #{sdNursRout},
            cd_nurs_level = #{cdNursLevel},
            sd_diet = #{sdDiet},
            sd_position = #{sdPosition},
            des_special = #{desSpecial}
        WHERE
            id_testexec_result_order = #{idTestexecResultOrder}
    </update>
    <update id="editDiagnosis">
        UPDATE exm_med_result_diagnosis
        SET
            id_die = #{idDie}
        WHERE
            id_testexec_result_diagnosis = #{idTestexecResultDiagnosis}
    </update>
    <update id="editSummary">
        UPDATE exm_med_result_summary
        SET
            die_sumary = #{dieSumary}
        WHERE
            id_testexec_result_sumary = #{idTestexecResultSumary}
    </update>
    <update id="editExamQa">
        update
            exm_med_result_inspect
        set
            id_die = #{idDie}
        where
            id_testexec_result = #{idTestexecResult}
        and id_med_case_list = #{idMedCaseList}
        and fg_valid = '0'
    </update>
    <update id="editCheckQa">
        update
            exm_med_result_body
        set
            id_die = #{idDie}
        where
            id_testexec_result = #{idTestexecResult}
        and id_med_case_list = #{idMedCaseList}
        and fg_valid = '0'
    </update>
    <update id="editEva">
        update exm_eva_dimension
        set score_dimemsion = #{scoreDimemsion},
            weight_score_dimemsion = ROUND(score_dimemsion * weight_dimemsion/100,2)
        where id_testexec_result_dimension = #{idTestexecResultDimension}
    </update>
    <update id="updateExmMedResultFlag">
        update exm_med_result set fg_asses = '1' where id_testexec_result = #{idTestexecResult}
    </update>
    <update id="updateQzFlag">
        update exm_med_result_diagnosis set fg_valid = '1' where id_testexec_result_referral=#{idTestexecResultReferral}
    </update>
    <delete id="delCheckQa">
        update exm_med_result_body
        set
            <if test="idDie != null">
                id_die = #{idDie},
            </if>
            fg_valid=#{fgValid},
            gmt_create=now()
        where id_testexec_result_body = #{idTestexecResultBody}
    </delete>
    <delete id="delExamQa">
        update exm_med_result_inspect
        set
            <if test="idDie != null">
                id_die = #{idDie},
            </if>
            fg_valid=#{fgValid},
            gmt_create=now()
        where id_testexec_result_inspect = #{idTestexecResultInspect}
    </delete>
    <delete id="delLongDrugs">
        update exm_med_result_order_log_drugs set fg_valid = '1' where id_order_long_drugs = #{id}
    </delete>
    <delete id="delShortDrugs">
        update exm_med_result_order_short_drugs set fg_valid = '1' where id_order_short_drugs = #{id}
    </delete>
    <delete id="delDiagnosis">
        update exm_med_result_diagnosis set fg_valid = '1' where id_testexec_result_diagnosis = #{idTestexecResultDiagnosis}
    </delete>
    <delete id="delDieReason">
        update exm_med_result_die_reason set fg_valid = '1' where id_die_reason = #{idDieReason}
    </delete>
    <delete id="delDieReasonByResultId">
        update exm_med_result_die_reason set fg_valid = '1' where id_testexec_result_diagnosis = #{idTestexecResultDiagnosis}
    </delete>
    <delete id="delQzDieReason">
        delete from exm_med_result_die_reason where id_testexec_result_diagnosis = #{idTestexecResultDiagnosis}
    </delete>
    <delete id="delPlanDetail">
        delete from exm_testplan_detail
        WHERE
        id_testplan_detail in (
        <foreach collection="list" item="item" separator="," >
            #{item}
        </foreach>
        )
    </delete>

    <select id="countWaitingRoom" resultType="java.lang.Long">
        SELECT
            count(1)
        FROM
            exm_testplan_detail a
        LEFT JOIN faq_med_tag b ON a.id_medicalrec = b.id_medicalrec
        LEFT JOIN bas_medical_tag c ON b.id_tag = c.id_tag AND c.cd_med_asse = '003'
        LEFT JOIN faq_med_case_patient d ON d.id_med_case = b.id_med_case
        LEFT JOIN user_info e ON a.id_student = e.user_id
        LEFT JOIN exm_testplan f ON a.id_testplan = f.id_testplan
        LEFT JOIN exm_testpaper g ON f.id_testpaper = g.id_testpaper
        LEFT JOIN faq_medicalrec k ON a.id_medicalrec = k.id_medicalrec
        WHERE
            a.sd_testplan_detail IN('0' , '1')
        AND f.id_org = #{idOrg}
        AND d.id_med_case IS NOT NULL
        <if test="medicalrecName != null and medicalrecName != ''">
            and k.name like concat(#{medicalrecName},'%')
        </if>
        <if test="naTestplan != null and naTestplan != ''">
            and f.na_testplan like concat(#{naTestplan},'%')
        </if>
        <if test="naTestpaper != null and naTestpaper != ''">
            and g.na_testpaper like concat(#{naTestpaper},'%')
        </if>
        <if test="currentUserId != null">
            and a.id_student = #{currentUserId}
        </if>
    </select>
    <select id="listWaitingRoom" resultType="com.sm.open.core.model.vo.pf.biz.test.PfTestWaitingRoomVo">
        SELECT
            a.id_testplan_detail,
            a.sd_testplan_detail as status,
            a.id_testplan ,
            a.id_student ,
            b.id_medicalrec,
            c.id_demo ,
            d.name as patName,
            d.sex as patSex,
            e.real_name as distributeDoc,
            f.na_testplan ,
            f.id_testpaper ,
            g.na_testpaper
        FROM
            exm_testplan_detail a
        LEFT JOIN faq_med_tag b ON a.id_medicalrec = b.id_medicalrec
        LEFT JOIN bas_medical_tag c ON b.id_tag = c.id_tag AND c.cd_med_asse = '003'
        LEFT JOIN faq_med_case_patient d ON d.id_med_case = b.id_med_case
        LEFT JOIN user_info e ON a.id_student = e.user_id
        LEFT JOIN exm_testplan f ON a.id_testplan = f.id_testplan
        LEFT JOIN exm_testpaper g ON f.id_testpaper = g.id_testpaper
        LEFT JOIN faq_medicalrec k ON a.id_medicalrec = k.id_medicalrec
        WHERE
            a.sd_testplan_detail IN('0' , '1')
        AND f.id_org = #{idOrg}
        AND d.id_med_case IS NOT NULL
        <if test="medicalrecName != null and medicalrecName != ''">
            and k.name like concat(#{medicalrecName},'%')
        </if>
        <if test="naTestplan != null and naTestplan != ''">
            and f.na_testplan like concat(#{naTestplan},'%')
        </if>
        <if test="naTestpaper != null and naTestpaper != ''">
            and g.na_testpaper like concat(#{naTestpaper},'%')
        </if>
        <if test="currentUserId != null">
            and a.id_student = #{currentUserId}
        </if>
        limit #{offset}, #{limit}
    </select>
    <select id="countReceivePat" resultType="java.lang.Long">
        SELECT
            count(1)
        FROM
            exm_testexec m
        LEFT JOIN exm_testplan_detail a ON m.id_testplan_detail = a.id_testplan_detail
        LEFT JOIN faq_med_tag b ON a.id_medicalrec = b.id_medicalrec
        LEFT JOIN faq_medicalrec k ON b.id_medicalrec = k.id_medicalrec
        LEFT JOIN bas_medical_tag c ON b.id_tag = c.id_tag AND c.cd_med_asse = '003'
        LEFT JOIN faq_med_case_patient d ON d.id_med_case = b.id_med_case
        LEFT JOIN user_info e ON a.id_student = e.user_id
        LEFT JOIN exm_testplan f ON a.id_testplan = f.id_testplan
        LEFT JOIN exm_testpaper g ON f.id_testpaper = g.id_testpaper
        LEFT JOIN exm_med_result o ON o.id_testexec = m.id_testexec
        LEFT JOIN exm_eva_result p ON o.id_testexec_result = p.id_testexec_result
        WHERE
            a.sd_testplan_detail = '2'
        and m.sd_testexec = '2'
        AND f.id_org = #{idOrg}
        <if test="medicalrecName != null and medicalrecName != ''">
            and k.name like concat(#{medicalrecName},'%')
        </if>
        <if test="naTestplan != null and naTestplan != ''">
            and f.na_testplan like concat(#{naTestplan},'%')
        </if>
        <if test="naTestpaper != null and naTestpaper != ''">
            and g.na_testpaper like concat(#{naTestpaper},'%')
        </if>
        <if test="fgAsses != null and fgAsses != ''">
            <choose>
                <when test='fgAsses == "2"'>
                    and o.fg_asses ='1'
                </when>
                <otherwise>
                    and o.fg_asses !='1'
                </otherwise>
            </choose>
        </if>
        AND d.id_med_case IS NOT NULL
    </select>
    <select id="listReceivePat" resultType="com.sm.open.core.model.vo.pf.biz.test.PfTestReceivePatVo">
        SELECT
            a.id_testplan_detail ,
            o.id_testexec_result,
            case when o.fg_asses ='1' then '2' else '1' end  AS status ,
            a.id_testplan ,
            a.id_student ,
            m.dt_exec_begin AS receiveDate ,
            m.duration AS receiveConsumingTime ,
            b.id_medicalrec ,
            c.id_demo ,
            d.name AS patName ,
            d.sex AS patSex ,
            d.age ,
            k.name AS receiveDoc ,
            e.real_name AS medicalrecName ,
            f.na_testplan ,
            f.id_testpaper ,
            g.na_testpaper ,
            p.score_weight AS score ,
            p.sd_title AS ch ,
            '' AssessTeacher ,
            '' AssessDate
        FROM
            exm_testexec m
        LEFT JOIN exm_testplan_detail a ON m.id_testplan_detail = a.id_testplan_detail
        LEFT JOIN faq_med_tag b ON a.id_medicalrec = b.id_medicalrec
        LEFT JOIN faq_medicalrec k ON b.id_medicalrec = k.id_medicalrec
        LEFT JOIN bas_medical_tag c ON b.id_tag = c.id_tag AND c.cd_med_asse = '003'
        LEFT JOIN faq_med_case_patient d ON d.id_med_case = b.id_med_case
        LEFT JOIN user_info e ON a.id_student = e.user_id
        LEFT JOIN exm_testplan f ON a.id_testplan = f.id_testplan
        LEFT JOIN exm_testpaper g ON f.id_testpaper = g.id_testpaper
        LEFT JOIN exm_med_result o ON o.id_testexec = m.id_testexec
        LEFT JOIN exm_eva_result p ON o.id_testexec_result = p.id_testexec_result
        WHERE
            a.sd_testplan_detail = '2'
        and m.sd_testexec = '2'
        AND f.id_org = #{idOrg}
        AND d.id_med_case IS NOT NULL
        <if test="medicalrecName != null and medicalrecName != ''">
            and k.name like concat(#{medicalrecName},'%')
        </if>
        <if test="naTestplan != null and naTestplan != ''">
            and f.na_testplan like concat(#{naTestplan},'%')
        </if>
        <if test="naTestpaper != null and naTestpaper != ''">
            and g.na_testpaper like concat(#{naTestpaper},'%')
        </if>
        <if test="fgAsses != null and fgAsses != ''">
            <choose>
                <when test='fgAsses == "2"'>
                    and o.fg_asses ='1'
                </when>
                <otherwise>
                    and o.fg_asses !='1'
                </otherwise>
            </choose>
        </if>
        limit #{offset}, #{limit}
    </select>

    <select id="selectTestPaperInfo"
            resultType="com.sm.open.core.model.vo.pf.biz.test.paper.PfTestPaperInfoVo">
        select
            a.id_testexec, a.dt_exec_begin as beginTime, a.dt_exec_end as endTime, b.id_testexec_result, a.sd_testexec
        from
            exm_testexec a
        left join exm_med_result b on a.id_testexec = b.id_testexec and b.serial = 1
        where
        <choose>
            <when test="idTestexecResult != null">
                b.id_testexec_result = #{idTestexecResult}
            </when>
            <otherwise>
                a.id_testplan_detail = #{idTestplanDetail}
                and a.id_student=#{idStudent}
            </otherwise>
        </choose>
    </select>
    <select id="selectPatInfo" resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomPatVo">
        SELECT
            c.name ,
            c.sex ,
            c.age ,
            c.complaint
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        LEFT JOIN faq_med_case_patient c ON c.id_med_case = a.id_med_case
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
    </select>
    <select id="selectPhotoInfo" resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomPatVo">
        SELECT
            a.id_med_case as ext
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = '005'
    </select>
    <select id="countTestCons" resultType="java.lang.Long">
        SELECT
            count(1)
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        LEFT JOIN faq_med_case_inques_list c ON c.id_med_case = a.id_med_case and c.fg_valid = '0'
        LEFT JOIN exm_med_result_inques d on c.id_med_case_list = d.id_med_case_list and d.fg_valid = '0'
        and d.id_testexec_result = #{idTestexecResult}
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
        <if test="extItemId != null">
          AND c.id_inques_ca = #{extItemId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND c.des_inques like concat('%',#{keyword},'%')
        </if>
    </select>
    <select id="listTestCons" resultType="com.sm.open.core.model.entity.FaqMedCaseInquesList">
        SELECT
            c.id_med_case_list ,
            c.id_inques ,
            c.des_inques,
            IF(d.id_med_case_list is null,0,1) as extQa
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        LEFT JOIN faq_med_case_inques_list c ON c.id_med_case = a.id_med_case and c.fg_valid = '0'
        LEFT JOIN exm_med_result_inques d on c.id_med_case_list = d.id_med_case_list and d.fg_valid = '0'
        and d.id_testexec_result = #{idTestexecResult}
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
        <if test="extItemId != null">
            AND c.id_inques_ca = #{extItemId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND c.des_inques like concat('%',#{keyword},'%')
        </if>
        order by
            c.id_med_case_list
        limit #{offset}, #{limit}
    </select>
    <select id="listConsQa" resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomConsVo">
        SELECT
            a.id_testexec_result_inques , a.fg_clue ,
            b.des_inques , b.id_answer , b.des_answer , b.des_expert ,
            c.sd_type, c.path
        FROM
            exm_med_result_inques a
        LEFT JOIN faq_med_case_inques_list b ON a.id_med_case_list = b.id_med_case_list
        LEFT JOIN bas_media c on b.id_media = c.id_media
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        and a.fg_valid = '0'
        order by
            a.gmt_create desc
    </select>
    <select id="isExistConsQa" resultType="java.lang.Long">
        select
            id_testexec_result_inques
        from
            exm_med_result_inques
        where
            id_testexec_result = #{idTestexecResult}
        and id_med_case_list = #{idMedCaseList}
    </select>

    <select id="selectPic" resultType="java.lang.Long">
        SELECT
           a.id_med_case
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        WHERE
             a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
        limit 1
    </select>

    <select id="countTestCheck" resultType="java.lang.Long">
        SELECT
            count(1)
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        LEFT JOIN faq_med_case_body_list c ON c.id_med_case = a.id_med_case AND c.fg_valid = '0'
        LEFT JOIN bas_body_ca e ON c.id_body_ca = e.id_body_ca
        LEFT JOIN exm_med_result_body d ON c.id_med_case_list = d.id_med_case_list AND d.fg_valid = '0'
        and d.id_testexec_result = #{idTestexecResult}
        left join bas_die f on d.id_die = f.id_die
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
        <if test="sdBody != null and sdBody != ''">
            AND c.sd_body = #{sdBody}
        </if>
        <if test="extItemId != null">
            AND c.id_body_ca = #{extItemId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND c.des_body like concat('%',#{keyword},'%')
        </if>
    </select>
    <select id="listTestCheck" resultType="com.sm.open.core.model.entity.FaqMedCaseBodyList">
        SELECT
            c.id_med_case_list ,
            c.des_body ,
            c.id_body ,
            c.cd_check ,
            e.name AS cdCheckText , d.id_die, f.name as idDieText,
            IF(d.id_med_case_list IS NULL , 0 , 1) AS extQa
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        LEFT JOIN faq_med_case_body_list c ON c.id_med_case = a.id_med_case AND c.fg_valid = '0'
        LEFT JOIN bas_body_ca e ON c.id_body_ca = e.id_body_ca
        LEFT JOIN exm_med_result_body d ON c.id_med_case_list = d.id_med_case_list AND d.fg_valid = '0'
        and d.id_testexec_result = #{idTestexecResult}
        left join bas_die f on d.id_die = f.id_die
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
        <if test="sdBody != null and sdBody != ''">
            AND c.sd_body = #{sdBody}
        </if>
        <if test="extItemId != null">
            AND c.id_body_ca = #{extItemId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND c.des_body like concat('%',#{keyword},'%')
        </if>
        ORDER BY
            c.id_med_case_list
        limit #{offset}, #{limit}
    </select>
    <select id="isExistCheckQa" resultType="java.lang.Long">
        select
            id_testexec_result_body
        from
            exm_med_result_body
        where
            id_testexec_result = #{idTestexecResult}
        and id_med_case_list = #{idMedCaseList}
    </select>
    <select id="countTestExam" resultType="java.lang.Long">
        SELECT
            count(1)
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        LEFT JOIN faq_med_case_inspect_list c ON c.id_med_case = a.id_med_case and c.fg_valid = '0'
        LEFT JOIN exm_med_result_inspect d on c.id_med_case_list = d.id_med_case_list and d.fg_valid = '0'
        and d.id_testexec_result = #{idTestexecResult}
        left join bas_die e on d.id_die = e.id_die
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
        <if test="extItemId != null">
            AND c.id_inspect = #{extItemId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND c.na_item like concat('%',#{keyword},'%')
        </if>
    </select>
    <select id="listTestExam" resultType="com.sm.open.core.model.entity.FaqMedCaseInspectList">
        SELECT
            c.id_med_case_list ,
	        c.na_item,
	        c.id_inspect_item, d.id_die, e.name as idDieText,
            IF(d.id_med_case_list is null,0,1) as extQa
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        LEFT JOIN faq_med_case_inspect_list c ON c.id_med_case = a.id_med_case and c.fg_valid = '0'
        LEFT JOIN exm_med_result_inspect d on c.id_med_case_list = d.id_med_case_list and d.fg_valid = '0'
        and d.id_testexec_result = #{idTestexecResult}
        left join bas_die e on d.id_die = e.id_die
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
        <if test="extItemId != null">
            AND c.id_inspect = #{extItemId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND c.na_item like concat('%',#{keyword},'%')
        </if>
        order by
            c.id_med_case_list
        limit #{offset}, #{limit}
    </select>
    <select id="isExistExamQa" resultType="java.lang.Long">
        select
            id_testexec_result_inspect
        from
            exm_med_result_inspect
        where
            id_testexec_result = #{idTestexecResult}
        and id_med_case_list = #{idMedCaseList}
    </select>
    <select id="listCheckQa" resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomCheckVo">
        SELECT
            a.id_testexec_result_body , a.fg_clue ,
            b.des_body , b.id_result , b.des_result , b.des_expert ,
            c.sd_type, c.path
        FROM
            exm_med_result_body a
        LEFT JOIN faq_med_case_body_list b ON a.id_med_case_list = b.id_med_case_list
        LEFT JOIN bas_media c on b.id_media = c.id_media
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        and a.fg_valid = '0'
        order by
            a.gmt_create desc
    </select>
    <select id="listExamQa" resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomExamVo">
        SELECT
            a.id_testexec_result_inspect , a.fg_clue ,
            b.na_item , b.id_result , b.val_result, b.des_stand, b.des_expert ,
            c.sd_type, c.path
        FROM
            exm_med_result_inspect a
        LEFT JOIN faq_med_case_inspect_list b ON a.id_med_case_list = b.id_med_case_list
        LEFT JOIN bas_media c on b.id_media = c.id_media
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        and a.fg_valid = '0'
        order by
            a.gmt_create desc
    </select>
    <select id="listReferral" resultType="com.sm.open.core.model.entity.ExmMedResultReferral">
        SELECT
            a.id_testexec_result_referral, a.id_testexec_result, a.sd_eva_referral, 
            a.id_die, a.reason_in, a.fg_exclude, a.reason_out, a.fg_valid, a.gmt_create, a.gmt_modify,
            b.name as idDieText
        FROM
            exm_med_result_referral a
        LEFT JOIN bas_die b ON a.id_die = b.id_die
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        and a.fg_valid = '0'
    </select>
    <select id="selectOrders" resultType="com.sm.open.core.model.entity.ExmMedResultOrder">
        SELECT
            id_testexec_result_order ,
            id_testexec_result ,
            des_check ,
            sd_nurs_rout ,
            cd_nurs_level ,
            sd_diet ,
            sd_position ,
            des_special ,
            fg_valid ,
            gmt_create
        FROM
            exm_med_result_order
        WHERE
            fg_valid = '0'
        and id_testexec_result = #{idTestexecResult}
        LIMIT 1
    </select>
    <select id="listLongDrugs" resultType="com.sm.open.core.model.entity.ExmMedResultOrderLogDrugs">
        SELECT
            a.id_order_long_drugs, a.id_testexec_result_order, a.id_long_drugs, a.fg_valid, b.name as idLongDrugsText
        FROM
            exm_med_result_order_log_drugs a
        LEFT JOIN bas_drugs b on a.id_long_drugs = b.id_drugs
        WHERE
            a.fg_valid = '0'
        and a.id_testexec_result_order = #{idTestexecResultOrder}
    </select>
    <select id="listShortDrugs" resultType="com.sm.open.core.model.entity.ExmMedResultOrderShortDrugs">
        SELECT
            a.id_order_short_drugs, a.id_testexec_result_order, a.id_short_drugs, a.fg_valid, b.name as idShortDrugsText
        FROM
            exm_med_result_order_short_drugs a
        LEFT JOIN bas_drugs b on a.id_short_drugs = b.id_drugs
        WHERE
            a.fg_valid = '0'
        and a.id_testexec_result_order = #{idTestexecResultOrder}
    </select>
    <select id="listDiagnosis" resultType="com.sm.open.core.model.entity.ExmMedResultDiagnosis">
        select
            a.id_testexec_result_diagnosis,
            a.id_testexec_result,
            a.id_die,
            a.gmt_create,
            b.name as idDieText
        from exm_med_result_diagnosis a
        left join bas_die b on a.id_die = b.id_die
        where
            a.id_testexec_result = #{idTestexecResult}
        and a.fg_valid = '0'
    </select>
    <select id="selectDiagnosis" resultType="com.sm.open.core.model.entity.ExmMedResultDiagnosis">
        select   
            a.id_testexec_result_diagnosis,
            a.id_testexec_result,
            a.id_die,
            a.fg_valid,
            a.gmt_create, b.name as idDieText
        from exm_med_result_diagnosis a
        left join bas_die b on a.id_die = b.id_die
        where
            a.id_testexec_result = #{idTestexecResult}
        and a.fg_valid = '0'
        limit 1
    </select>
    <select id="selectSummary" resultType="com.sm.open.core.model.entity.ExmMedResultSummary">
        select
            id_testexec_result_sumary,
            id_testexec_result,
            die_sumary,
            fg_valid,
            gmt_create
        from
            exm_med_result_summary
        where
            id_testexec_result = #{idTestexecResult}
        and fg_valid = '0'
        limit 1
    </select>
    <select id="listDieReason" resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomDieReasonVo">
        SELECT
            a.id_die_reason, a.id_testexec_result_diagnosis, a.sd_eva_effciency,a.id_med_case_list as id,
            case a.sd_eva_effciency when '1' then b.des_inques when '2' then c.des_body when '3' then d.na_item else '' end as idText        FROM
            exm_med_result_die_reason a
        LEFT JOIN faq_med_case_inques_list b ON a.id_med_case_list = b.id_med_case_list
        AND a.sd_eva_effciency = 1
        LEFT JOIN faq_med_case_body_list c ON a.id_med_case_list = c.id_med_case_list
        AND a.sd_eva_effciency = 2
        LEFT JOIN faq_med_case_inspect_list d ON a.id_med_case_list = d.id_med_case_list
        AND a.sd_eva_effciency = 3
        where a.id_testexec_result_diagnosis = #{idTestexecResultDiagnosis}
        and a.fg_valid = '0'
    </select>
    <select id="listReadyDieReason"
            resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomDieReasonVo">
        SELECT
            '1' AS sdEvaEffciency ,
            a.id_med_case_list AS id ,
            b.des_inques AS idText,
            b.id_inques as extId
        FROM
            exm_med_result_inques a
        LEFT JOIN faq_med_case_inques_list b ON a.id_med_case_list = b.id_med_case_list
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        AND a.fg_valid = '0'
        UNION ALL
        SELECT
            '2' AS sdEvaEffciency ,
            a.id_med_case_list AS id ,
            b.des_body AS idText,
            b.id_body as extId
        FROM
            exm_med_result_body a
        LEFT JOIN faq_med_case_body_list b ON a.id_med_case_list = b.id_med_case_list
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        AND a.fg_valid = '0'
        UNION ALL
        SELECT
            '3' AS sdEvaEffciency ,
            a.id_med_case_list AS id ,
            b.na_item AS idText,
            b.id_inspect_item as extId
        FROM
            exm_med_result_inspect a
        LEFT JOIN faq_med_case_inspect_list b ON a.id_med_case_list = b.id_med_case_list
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        AND a.fg_valid = '0'
    </select>
    <select id="listEva" resultType="com.sm.open.core.model.vo.pf.biz.test.eva.PfEvaExecVo">
        SELECT
            a.id_testexec_result_dimension ,
            a.id_testexec_result ,
            a.id_dimemsion ,
            a.score_max,
            a.weight_score_max,
            IF(b.par_dimemsion is null,'',b.name) as nzName,
	        IF(b.par_dimemsion is null, b.name, '') as pgItem,
            b.par_dimemsion ,
            a.weight_dimemsion ,
            a.score_dimemsion ,
            a.weight_score_dimemsion,
            b.fg_system_algorithm
        FROM
            exm_eva_dimension a
        LEFT JOIN bas_demo_asses b ON a.id_dimemsion = b.id_dimemsion
        WHERE
            id_testexec_result = #{idTestexecResult}
        ORDER BY
            IFNULL(b.par_dimemsion, a.id_dimemsion) , a.id_dimemsion,
            b.sort
    </select>
    <select id="getScore" resultType="com.sm.open.core.model.vo.pf.biz.test.eva.PfEvaExecVo">
        SELECT
            a.id_dimemsion,
            max(b. NAME) AS pgItem ,
            ROUND(AVG(a.weight_score_dimemsion), 3) as avgScore
        FROM
            exm_eva_dimension a
        LEFT JOIN bas_demo_asses b ON a.id_dimemsion = b.id_dimemsion
        WHERE
            a.id_testexec_result in (
            <foreach collection="list" item="item" separator="," >
                #{item}
            </foreach>
        )
        AND b.par_dimemsion IS NULL
        GROUP BY
            a.id_dimemsion
        ORDER BY
            a.id_dimemsion
    </select>
    <select id="getExecResultId" resultType="java.lang.Long">
        SELECT
            b.id_testexec_result
        FROM
            exm_testexec a
        LEFT JOIN exm_med_result b ON a.id_testexec = b.id_testexec
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.fg_final_result = '1'
        AND fg_asses = '1'
    </select>
    <select id="listEvaLog" resultType="com.sm.open.core.model.entity.ExmEvaLog">
        select* from exm_eva_log where id_testexec_result_dimension in
        (select id_testexec_result_dimension from exm_eva_dimension where id_testexec_result =  #{idTestexecResult})
    </select>

    <select id="medEva" statementType="CALLABLE" >
        call P_EVA_AMAIN(
            #{idTestexecResult,mode=IN,jdbcType=INTEGER},
            #{parCode,mode=OUT,jdbcType=INTEGER},
            #{parMsg,mode=OUT,jdbcType=VARCHAR}
        )
    </select>
    <select id="listExecLogInques" resultType="com.sm.open.core.model.vo.pf.biz.test.eva.PfExecLogVo">
        SELECT
            '问诊' as stage,
            '添加问诊' as operation,
            b.des_inques as answer,
            a.gmt_create as logDate
        FROM
            exm_med_result_inques a
        left join faq_med_case_inques_list b on a.id_inques = b.id_inques
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        AND a.fg_valid = '0'
    </select>
    <select id="listExecLogBody" resultType="com.sm.open.core.model.vo.pf.biz.test.eva.PfExecLogVo">
        SELECT
            '检查' as stage,
            '添加检查' as operation,
            b.des_body as answer,
            a.gmt_create as logDate
        FROM
            exm_med_result_body a
        left join faq_med_case_body_list b on a.id_body = b.id_body
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        AND a.fg_valid = '0'
    </select>
    <select id="listExecLogInspect" resultType="com.sm.open.core.model.vo.pf.biz.test.eva.PfExecLogVo">
        SELECT
            '检验' as stage,
            '添加检验' as operation,
            b.na_item as answer,
            a.gmt_create as logDate
        FROM
            exm_med_result_inspect a
        left join faq_med_case_inspect_list b on a.id_inspect_item = b.id_inspect_item
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        AND a.fg_valid = '0'
    </select>
    <select id="selectEvaResult" resultType="com.sm.open.core.model.entity.ExmEvaResult">
        select id_testexec_result,score_weight,sd_title
        from exm_eva_result
        where id_testexec_result = #{idTestexecResult}
        limit 1
    </select>
    <select id="listExecLogDiagnosis" resultType="com.sm.open.core.model.vo.pf.biz.test.eva.PfExecLogVo">
         SELECT	
            a.id_testexec_result_diagnosis as extId,
            '诊断' as stage,
            '添加诊断' as operation,
            b.name as answer,
            a.gmt_create as logDate
        FROM
            exm_med_result_diagnosis a
        left join bas_die b on a.id_die = b.id_die
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        AND a.fg_valid = '0'
    </select>
    <select id="listExecLogDiagnosisReason" resultType="com.sm.open.core.model.vo.pf.biz.test.eva.PfExecLogVo">
        SELECT
            '诊断' AS stage ,
            '添加诊断理由' AS operation ,
            '' AS answer ,
            gmt_create AS logDate
        FROM
            exm_med_result_die_reason
        WHERE
            id_testexec_result_diagnosis = #{idTestexecResultDiagnosis}
    </select>
    <select id="listExecLogOrder" resultType="com.sm.open.core.model.vo.pf.biz.test.eva.PfExecLogVo">

    </select>
    <select id="selectAllReferral" resultType="com.sm.open.core.model.entity.ExmMedResultReferral">
        select
           a.id_testexec_result_referral,
           a.id_testexec_result ,
           a.id_die ,
           a.fg_exclude ,
           a.fg_valid ,
           a.gmt_create ,
           a.gmt_modify, b.name as idDieText
        from exm_med_result_referral a
        left join bas_die b on a.id_die = b.id_die
        WHERE
            a.id_testexec_result = #{idTestexecResult}
          AND a.fg_valid = '0'
    </select>
    <select id="listReferralReason" resultType="com.sm.open.core.model.vo.pf.biz.test.PfReferralReasonVo">
        SELECT
            a.id_referral_reason ,
            a.id_testexec_result_referral ,
            a.sd_eva_effciency ,
            a.id_med_case_list AS id ,
            a.fg_exclude ,
            CASE a.sd_eva_effciency
                WHEN '1' THEN
                    b.des_inques
                WHEN '2' THEN
                    c.des_body
                WHEN '3' THEN
                    d.na_item
                ELSE
                    ''
                END AS idText
        FROM
            exm_med_result_referral_reason a
                LEFT JOIN faq_med_case_inques_list b ON a.id_med_case_list = b.id_med_case_list
                AND a.sd_eva_effciency = 1
                LEFT JOIN faq_med_case_body_list c ON a.id_med_case_list = c.id_med_case_list
                AND a.sd_eva_effciency = 2
                LEFT JOIN faq_med_case_inspect_list d ON a.id_med_case_list = d.id_med_case_list
                AND a.sd_eva_effciency = 3
        WHERE
            a.id_testexec_result_referral = #{idTestexecResultReferral}
        AND a.fg_valid = '0'
        order by a.gmt_create
    </select>
    <select id="selectQzId" resultType="java.lang.Long">
        SELECT
            a.id_testexec_result_diagnosis
        FROM
            exm_med_result_diagnosis a
        WHERE
            a.id_testexec_result_referral = #{idTestexecResultReferral}
    </select>
    <select id="selectDelPlanDetailstatus" resultType="java.lang.Integer">
        select
            count(1)
        from
            exm_testplan_detail
        WHERE
            id_testplan_detail in (
        <foreach collection="list" item="item" separator="," >
            #{item}
        </foreach>
        )
        AND sd_testplan_detail != '0'
    </select>

</mapper>