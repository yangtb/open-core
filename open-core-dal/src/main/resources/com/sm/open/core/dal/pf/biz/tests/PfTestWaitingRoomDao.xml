<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sm.open.core.dal.pf.biz.tests.PfTestWaitingRoomDao">
    <insert id="startExam" useGeneratedKeys="true" keyProperty="idTestexec">
        INSERT INTO exm_testexec
        (
        <trim suffixOverrides=",">
            <if test="idTestexec!=null">
                id_testexec,
            </if>
            <if test="idTestplanDetail!=null">
                id_testplan_detail,
            </if>
            <if test="idStudent!=null">
                id_student,
            </if>
            <if test="idMedicalrec!=null">
                id_medicalrec,
            </if>
            <if test="sort!=null">
                sort,
            </if>
            <if test="idOrg!=null">
                id_org,
            </if>
            <if test="sdTestexec!=null">
                sd_testexec,
            </if>
                dt_exec_begin,
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexec!=null">
                #{idTestexec},
            </if>
            <if test="idTestplanDetail!=null">
                #{idTestplanDetail},
            </if>
            <if test="idStudent!=null">
                #{idStudent},
            </if>
            <if test="idMedicalrec!=null">
                #{idMedicalrec},
            </if>
            <if test="sort!=null">
                #{sort},
            </if>
            <if test="idOrg!=null">
                #{idOrg},
            </if>
            <if test="sdTestexec!=null">
                #{sdTestexec},
            </if>
                now(),
        </trim>
        )
    </insert>
    <insert id="insertExmMedResult" useGeneratedKeys="true" keyProperty="idTestexecResult">
        INSERT INTO exm_med_result
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="idTestexec!=null">
                id_testexec,
            </if>
            <if test="serial!=null">
                serial,
            </if>
            <if test="fgFinalResult!=null">
                fg_final_result,
            </if>
            <if test="fgAsses!=null">
                fg_asses,
            </if>
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="idTestexec!=null">
                #{idTestexec},
            </if>
            <if test="serial!=null">
                #{serial},
            </if>
            <if test="fgFinalResult!=null">
                #{fgFinalResult},
            </if>
            <if test="fgAsses!=null">
                #{fgAsses},
            </if>
        </trim>
        )
    </insert>
    <insert id="saveConsQa"  useGeneratedKeys="true" keyProperty="idTestexecResultInques">
        INSERT INTO exm_med_result_inques
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultInques!=null">
                id_testexec_result_inques,
            </if>
            <if test="idTestexecResult!=null">
                id_testexec_result,
            </if>
            <if test="idInques!=null">
                id_inques,
            </if>
            <if test="idMedCaseList!=null">
                id_med_case_list,
            </if>
                fg_clue,
                gmt_create,
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="idTestexecResultInques!=null">
                #{idTestexecResultInques},
            </if>
            <if test="idTestexecResult!=null">
                #{idTestexecResult},
            </if>
            <if test="idInques!=null">
                #{idInques},
            </if>
            <if test="idMedCaseList!=null">
                #{idMedCaseList},
            </if>
                '0',
                now(),
        </trim>
        )
    </insert>
    <update id="endExam">
        update
            exm_testexec
        set
            dt_exec_end=now(),
            duration=TIMESTAMPDIFF(SECOND, dt_exec_begin, now()),
            sd_testexec='2'
        where
            id_testexec = #{idTestexec}
    </update>
    <update id="updateConsStatus">
        update
            exm_med_result_inques
        set
            fg_clue=#{status}
        where
            id_testexec_result_inques  in (
        <foreach collection="list" item="item" separator="," >
            #{item}
        </foreach>
        )
    </update>
    <update id="delConsQa">
        update exm_med_result_inques set fg_valid=#{fgValid} where id_testexec_result_inques = #{idTestexecResultInques}
    </update>


    <select id="countWaitingRoom" resultType="java.lang.Long">
        SELECT
            count(1)
        FROM
            exm_testplan_detail a
        LEFT JOIN faq_med_tag b ON a.id_medicalrec = b.id_medicalrec
        LEFT JOIN bas_medical_tag c ON b.id_tag = c.id_tag AND c.cd_med_asse = '003'
        LEFT JOIN faq_med_case_patient d ON d.id_med_case = b.id_med_case
        LEFT JOIN user_info e ON a.id_student = e.user_id
        LEFT JOIN exm_testplan f ON a.id_testplan = f.id_testplan
        LEFT JOIN exm_testpaper g ON f.id_testpaper = g.id_testpaper
        WHERE
            a.sd_testplan_detail IN('0' , '1')
        AND f.id_org = #{idOrg}
        AND d.id_med_case IS NOT NULL
    </select>
    <select id="listWaitingRoom" resultType="com.sm.open.core.model.vo.pf.biz.test.PfTestWaitingRoomVo">
        SELECT
            a.id_testplan_detail,
            a.sd_testplan_detail as status,
            a.id_testplan ,
            a.id_student ,
            b.id_medicalrec,
            c.id_demo ,
            d.name as patName,
            d.sex as patSex,
            e.real_name as distributeDoc,
            f.na_testplan ,
            f.id_testpaper ,
            g.na_testpaper
        FROM
            exm_testplan_detail a
        LEFT JOIN faq_med_tag b ON a.id_medicalrec = b.id_medicalrec
        LEFT JOIN bas_medical_tag c ON b.id_tag = c.id_tag AND c.cd_med_asse = '003'
        LEFT JOIN faq_med_case_patient d ON d.id_med_case = b.id_med_case
        LEFT JOIN user_info e ON a.id_student = e.user_id
        LEFT JOIN exm_testplan f ON a.id_testplan = f.id_testplan
        LEFT JOIN exm_testpaper g ON f.id_testpaper = g.id_testpaper
        WHERE
            a.sd_testplan_detail IN('0' , '1')
        AND f.id_org = #{idOrg}
        AND d.id_med_case IS NOT NULL
        limit #{offset}, #{limit}
    </select>
    <select id="countReceivePat" resultType="java.lang.Long">

    </select>
    <select id="listReceivePat" resultType="com.sm.open.core.model.vo.pf.biz.test.PfTestReceivePatVo">

    </select>

    <select id="selectTestPaperInfo"
            resultType="com.sm.open.core.model.vo.pf.biz.test.paper.PfTestPaperInfoVo">
        select
            a.id_testexec, a.dt_exec_begin as beginTime, a.dt_exec_end as endTime, b.id_testexec_result
        from
            exm_testexec a
        left join exm_med_result b on a.id_testexec = b.id_testexec and b.serial = 1
        where
            id_testplan_detail = #{idTestplanDetail}
        and id_student=#{idStudent}
    </select>
    <select id="selectPatInfo" resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomPatVo">
        SELECT
            c.name ,
            c.sex ,
            c.age ,
            c.complaint
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        LEFT JOIN faq_med_case_patient c ON c.id_med_case = a.id_med_case
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
    </select>
    <select id="selectPhotoInfo" resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomPatVo">
        SELECT
            a.id_med_case as ext
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = '005'
    </select>
    <select id="listTestCons" resultType="com.sm.open.core.model.entity.FaqMedCaseInquesList">
        SELECT
            c.id_med_case_list ,
            c.id_inques ,
            c.des_inques,
            IF(d.id_med_case_list is null,0,1) as extQa
        FROM
            faq_med_tag a
        LEFT JOIN bas_medical_tag b ON a.id_tag = b.id_tag
        LEFT JOIN faq_med_case_inques_list c ON c.id_med_case = a.id_med_case and c.fg_valid = '0'
        LEFT JOIN exm_med_result_inques d on c.id_med_case_list = d.id_med_case_list and d.fg_valid = '0'
        WHERE
            a.id_medicalrec = #{idMedicalrec}
        AND b.cd_med_asse = #{cdMedAsse}
        order by
            c.id_med_case_list
    </select>
    <select id="listConsQa" resultType="com.sm.open.core.model.vo.pf.biz.test.PfWaitingRoomConsVo">
        SELECT
            a.id_testexec_result_inques , a.fg_clue ,
            b.des_inques , b.id_answer , b.des_answer , b.des_expert ,
            c.sd_type, c.path
        FROM
            exm_med_result_inques a
        LEFT JOIN faq_med_case_inques_list b ON a.id_med_case_list = b.id_med_case_list
        LEFT JOIN bas_media c on b.id_media = c.id_media
        WHERE
            a.id_testexec_result = #{idTestexecResult}
        and a.fg_valid = '0'
        order by
            b.id_med_case_list
    </select>
    <select id="isExistConsQa" resultType="java.lang.Long">
        select
            id_testexec_result_inques
        from
            exm_med_result_inques
        where
            id_testexec_result = #{idTestexecResult}
        and id_med_case_list = #{idMedCaseList}
    </select>
</mapper>